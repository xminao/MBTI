# 2022/6/1 æ—¥æŠ¥

**ä»£ç å¢é‡æˆªå›¾**ï¼š

![ä»£ç å¢é‡](D:\Courses_spring_22\database-project\æ—¥æŠ¥\imgs\6-1\ä»£ç å¢é‡.jpg)



ğŸ“‘ **ä»Šå¤©ä¸»è¦åšäº†ä»€ä¹ˆ**ï¼š

- Jwté‰´æƒä½¿ç”¨



---

# ğŸ”‘ Jwté‰´æƒä½¿ç”¨

â€‹	Jwtç›¸å…³å†…å®¹åœ¨ä¹‹å‰çš„æ–‡æ¡£è¯´è¿‡ä¸€å¤§éƒ¨åˆ†ï¼ŒåŒ…æ‹¬å¦‚ä½•ç”ŸæˆToken(5-28æ—¥æŠ¥)ï¼Œè¿™æ¬¡è®²è®²go-zeroæ¡†æ¶è‡ªå¸¦çš„jwtå¦‚ä½•ä½¿ç”¨ã€‚

1 .ç™»å½•æˆåŠŸåå¾—åˆ°ä¸€ä¸ªTokenï¼Œå³è¿”å›å€¼ä¸­çš„"access_token"ã€‚

![jwttoken](D:\Courses_spring_22\database-project\æ—¥æŠ¥\imgs\6-1\jwttoken.jpg)

2 .åœ¨å…¶ä»–æœåŠ¡ä¸­ä½¿ç”¨é‰´æƒï¼Œä¾‹å¦‚æˆ‘ä»¬çš„å­¦æ ¡æœåŠ¡çš„è·å–å­¦ç”Ÿä¿¡æ¯éœ€è¦é‰´æƒ

```yaml
/* æˆ‘ä»¬éœ€è¦åœ¨ä½¿ç”¨é‰´æƒçš„æœåŠ¡é…ç½®ä¸­å¢åŠ Authï¼Œå³Tokenç”Ÿæˆé…ç½® */
/* /xxx/api/etc/xxx-api.yaml */
...
Auth:
  AccessSecret: 9429d707-f96e-4bc0-8ef6-249e1251ed92 #ä¸€èˆ¬é€‰æ‹©ä¸€ä¸ªUUIDä½œä¸ºç§é’¥
  AccessExpire: 86400
```

```go
/* /xxx/api/internal/config/config.go */
type Config struct {
	...
	Auth struct {
		AccessSecret string
		AccessExpire int64
	}
}
```

```
/* /xxx/api/xxx.api */
æˆ‘ä»¬åœ¨éœ€è¦ä½¿ç”¨Jwté‰´æƒçš„æœåŠ¡ä¸Šæ·»åŠ jwt
@server (
	jwt: Auth
)
service xxx-api {
	@handler GetInfo
	get /xxx/getinfo (GetInfoReq) returns (GetInfoResp)
}
```

è¿™æ ·ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªæœåŠ¡çš„æ—¶å€™ï¼Œå¦‚æœè¿›è¡Œè¯·æ±‚æ²¡æœ‰åœ¨å¤´éƒ¨å¸¦ä¸Šåœ¨ç™»å½•æ—¶ç”Ÿæˆçš„Tokenï¼Œé‚£ä¹ˆå°±æ— æ³•ç»§ç»­è®¿é—®äº†ã€‚

3 .åœ¨Postmanä¸­æµ‹è¯•Tokenæ•ˆæœã€‚

å°†ç¬¬ä¸€æ­¥ç”Ÿæˆçš„Tokenæ”¾è¿›å¦‚ä¸‹é…ç½®çš„Valueå€¼ä¸­ï¼ˆè¯·ç¡®ä¿ç”ŸæˆTokençš„ç§é’¥å’Œéœ€è¦ä½¿ç”¨é‰´æƒçš„æœåŠ¡æ‰€ç”¨çš„ç§é’¥æ˜¯ç›¸åŒçš„ï¼‰ã€‚

![postman](D:\Courses_spring_22\database-project\æ—¥æŠ¥\imgs\6-1\postman.jpg)

æ¥ç€è¿›è¡Œè¯·æ±‚å³å¯æˆåŠŸï¼Œå¦‚æœæ”¹æ‰Tokenï¼Œåˆ™ä¼šæ˜¾ç¤º401é”™è¯¯ï¼Œä¹Ÿå°±æ˜¯é‰´æƒå¤±è´¥ã€‚



---



# æ•°æ®åº“ç›¸å…³æ“ä½œ

â€‹	æ€»ç»“äº†ä¸€ä¸‹ä½¿ç”¨go-zeroçš„goctlå·¥å…·å¦‚ä½•æ“ä½œpostgresqlæ•°æ®åº“ã€‚

1 .é¦–å…ˆå»ºç«‹éœ€è¦çš„æ•°æ®åº“å’Œè¡¨ã€‚

2 .åœ¨å¯¹åº”çš„æœåŠ¡ä¸‹å»ºç«‹modelsæ–‡ä»¶ï¼Œä½¿ç”¨æŒ‡ä»¤ï¼š

```shell
// user:ç”¨æˆ·å,ä¸€èˆ¬æ˜¯postgres
// passwd:å¯†ç 
// dbname:éœ€è¦ç”Ÿæˆmodelsçš„æ•°æ®åº“å
// å¦‚æœéœ€è¦ç”Ÿæˆcacheæ“ä½œï¼Œè¯·åŠ ä¸Š-cï¼Œå¦åˆ™å»æ‰-cï¼Œåæ–‡é»˜è®¤ä½¿ç”¨cache
goctl model pg datasource -url="postgres://user:passwd@localhost:5432/dbname?sslmode=disable" -table="*" -c -dir .
```

3 .æ­¤æ—¶å³å¯ç”ŸæˆæˆåŠŸmodelsæ–‡ä»¶ï¼Œå¦‚æœæ˜¾ç¤ºæœªçŸ¥çš„modelæŒ‡ä»¤pgï¼Œæ£€æŸ¥ä½ çš„goctlç‰ˆæœ¬æ˜¯å¦æ˜¯1.3.6ï¼Œå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆè¯·é™ä½goctlç‰ˆæœ¬åˆ°1.3.5ã€‚

![models](D:\Courses_spring_22\database-project\æ—¥æŠ¥\imgs\6-1\models.jpg)

4 .é…ç½®æ–‡ä»¶éƒ¨åˆ†ã€‚

```yaml
/* /xxx/api/etc/xxx-api.yaml */
PgSQL:
  DataSource: postgres://user:passwd@localhost:5432/dbname?sslmode=disable
  
CacheRedis:
  - Host: localhost:6379
    Pass: passwd #å¦‚æœæ²¡æœ‰è®¾ç½®å¯†ç ï¼Œå»é™¤æ­¤é¡¹
    Type: node
```

```go
/*  /xxx/api/internal/config/config.go */
type Config struct {
	PgSQL struct {
		DataSource string
	}

	CacheRedis cache.CacheConf
}
```

5 .æœåŠ¡ä¾èµ–é…ç½®ã€‚

```go
/* /xxx/api/internal/svc/servicecontext.go */

import (
    ...
	_ "github.com/lib/pq" //é©±åŠ¨ï¼Œä¸€å®šè¦åŠ ä¸Š
	"github.com/zeromicro/go-zero/core/stores/sqlx"
)
type ServiceContext struct {
	Config config.Config
	
	//æ ¹æ®ç”Ÿæˆçš„modelsæ›´æ”¹
	xxxModel models.xxxModel
}

func NewServiceContext(c config.Config) *ServiceContext {
    //è¿æ¥æ•°æ®åº“
	conn := sqlx.NewSqlConn("postgres", c.PgSQL.DataSource)
	return &ServiceContext{
		Config: c,
		//models
		xxxModel: models.NewxxxModel(conn, c.CacheRedis),
	}
}
```

6 .ä¸šåŠ¡é€»è¾‘ä¸­å¯¹æ•°æ®åº“è¿›è¡Œæ“ä½œã€‚

```go
/* /xxx/api/internal/logic/xxxlogic.go */
func (l *xxxlogic) xxx(req *types.xxxReq) (*types.xxxResp, error) {
	//ä»¥æŸ¥æ‰¾ä¸ºä¾‹ï¼Œè°ƒç”¨modelså±‚goctlå°è£…çš„æŸ¥æ‰¾å‡½æ•°FindOne
	info, err := l.svcCtx.xxxModel.FindOne(l.ctx, req.Id)
	if err == models.ErrNotFound {
		return nil, errors.New("æœªæŸ¥è¯¢åˆ°å¯¹åº”è®°å½•")
	}
	return &types.xxxResp {
		...
	}, nil
}
```

modelså±‚æ ¹æ®å®é™…éœ€æ±‚å¯ä»¥å¢åŠ è‡ªå®šä¹‰çš„å‡½æ•°ï¼Œåœ¨ `xxxmodel.go` ä¸­è‡ªå®šä¹‰ï¼Œ`xxxmodel_gen.go `ä¸è¦ç¼–è¾‘ã€‚

"github.com/Masterminds/squirrel" ä¹Ÿæ˜¯ä¸€ç§sqlæŸ¥è¯¢å·¥å…·ï¼Œå¯¹postgresqlé€‚åº”æ€§ä¸é”™ã€‚